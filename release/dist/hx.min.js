!function(){"use strict";var i=function(){return(i=Object.assign||function(t){for(var e,r=1,s=arguments.length;r<s;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},r={baseURL:"/",headers:{"Content-Type":"application/json"},url:"/",mode:null,retryLimit:0,retryBuffer:3e3,debounceTime:300,throttleTime:3e3,withCredentials:!1,timeout:0,responseType:"json"},h=function(t,e){return typeof t===e},a="object",n="array",p=function(t,e){return h(e,a)?i({},t,e,{headers:i({},t.headers,e.headers)}):t},u=function(){function t(t,e,r){void 0===r&&(r={}),this.status=t.status,this.statusText=t.statusText,this.headers=i({},r),this.config=i({},e.config),this.data=function(t){switch(t.responseType){case"text":return t.response;default:return h(t.response,a)?t.response:JSON.parse(t.response)}}(t),this.request=e}return t.prototype.completeWithFulfilled=function(){this.request.success(this)},t.prototype.completeWithFailed=function(){this.request.failed(this)},t}(),c=function(t,e){t&&window.console.warn("[Warning]: "+e+" .")},f=/\/+$/,l=/^\/+/,e=/^([a-z]+:\/\/|\/\/)/,o=/^[23]/,d=function(t,e){return t.urlExp===e||"*"===t.urlExp||(r=t.urlExp,s=RegExp,r instanceof s&&t.urlExp.test(e));var r,s},y=function(t,e){if(e){t.replace(f,""),t+="?";var r=[];for(var s in e)r.push(s+"="+e[s]);t+=r.join("&")}return t.replace(f,"")},m=function(t){return e.test(t)},g=function(){function t(t){this._uuid=~~(1e9*Math.random()),this.url=t.url,this.method=t.method,this.baseURL=t.baseURL,this.headers=t.headers,this.params=t.params,this.mode=t.mode,this.retryLimit=t.retryLimit,this.retryBuffer=t.retryBuffer,this.debounceTime=t.debounceTime,this.throttleTime=t.throttleTime,this.data=t.data,this.timeout=t.timeout,this.withCredentials=t.withCredentials,this.responseType=t.responseType,this.config=t,this.withRushStore=!1}return t.prototype.success=function(t){this._onFulfilled&&this._onFulfilled(t)},t.prototype.failed=function(t){this._onFailed&&this._onFailed(t)},t.prototype.then=function(t){return this._onFulfilled=t,this},t.prototype.catch=function(t){return this._onFailed=t,this},t.prototype.abort=function(){if(this.aborted=!0,this.xhr){var t=this.hajaxInstance.store[this.url];(!t||t&&0===t.concurrentBuffer.length)&&this.xhr.abort()}},t.prototype.getUUID=function(){return this._uuid},t.prototype.accept=function(t){this.hajaxInstance=t},t.prototype.send=function(){var t,e,r,s;if(!this.aborted)if(this.fullURL=(t=this.config.baseURL,e=this.config.url,r=this.config.params,void 0===t&&(t="/"),s=m(e)?e:e?t.replace(f,"")+"/"+e.replace(l,""):t.replace(f,"/"),y(s,r)),"get"===this.method.toLowerCase()&&this.hajaxInstance.storeStrategy){var o=this.fullURL,i=function(t,r){var s=null;if(Array.isArray(t))t.some(function(t){var e=h(t,a);if(c(!e,"invalid param storeStrategy, expect ["+a+"] | ["+n+"] but got "+typeof t),e&&d(t,r))return s=t,!0});else{var e=h(t,a);c(!e,"invalid param storeStrategy, expect ["+a+"] | ["+n+"] but got "+typeof t),e&&d(t,r)&&(s=t)}return s}(this.hajaxInstance.storeStrategy,o);i?(this.withRushStore=this.hajaxInstance.checkStoreExpired(o),this.hajaxInstance.storeWithRule(i,this)):this.sendAjax()}else this.sendAjax()},t.prototype.initXHR=function(){var e=this,r=new XMLHttpRequest;for(var t in r.open(this.config.method.toUpperCase(),this.fullURL),this.config.headers)r.setRequestHeader(t,this.config.headers[t]);return r.timeout=this.config.timeout,r.responseType=this.config.responseType,r.withCredentials=this.config.withCredentials,r.onreadystatechange=function(){if(4==r.readyState)if(!o.test(r.status.toString())&&0<e.retryLimit)setTimeout(function(){e.sendAjax(),e.retryLimit--,e.hajaxInstance.store[e.fullURL]&&e.hajaxInstance.store[e.fullURL].xhr===r&&(e.hajaxInstance.store[e.fullURL].xhr=e.xhr)},e.retryBuffer);else{var t=r.getAllResponseHeaders().trim().split(/[\r\n]+/),s={};t.forEach(function(t){var e=t.split(": "),r=e.shift();s[r]=e.join(": ")}),e.hajaxInstance._runResp(new u(r,e,s))}},this.xhr=r},t.prototype.sendAjax=function(){this.initXHR(),this.xhr.send(JSON.stringify(this.data))},t}(),s=function(){function t(){this._queue=[]}return t.prototype.enqueue=function(t){this._queue.push(t)},t.prototype.unqueue=function(){return this._queue.shift()},t.prototype.hasItem=function(){return 0<this._queue.length},t}(),q="debounce",x="throttle",R=function(t,e,r){c(!t,"url in store strategy is invalid"),this.urlExp=t,this.bufferTime=~~e||-1,this.autoRetry=!!r},t=new(function(){function e(t){void 0===t&&(t={}),this.config=p(r,t),this.store={},this.requestQueue=new s,this.responseQueue=new s,this.requestPool={},this.debounceStore={},this.throttleStore={},this.storeStrategy=null,this._requestDealTarget=null}return e.prototype._runReq=function(t){var e=this,r=function(){t.accept(e),e.requestQueue.enqueue(t),e._emitRequestFlow()},s=t.mode,o=t.url,i=t.debounceTime,n=t.throttleTime;switch(s){case q:this.debounceStore[o]||(this.debounceStore[o]={timer:null});var u=this.debounceStore[o];u.timer&&clearTimeout(u.timer),u.timer=setTimeout(function(){r(),clearTimeout(u.timer)},i);break;case x:this.throttleStore[o]||(this.throttleStore[o]={ban:!1});var h=this.throttleStore[o];h.ban||(h.ban=!0,setTimeout(function(){h.ban=!1},n),r());break;default:r()}},e.prototype._emitRequestFlow=function(){!this._requestDealTarget&&this.requestQueue.hasItem()&&(this._requestDealTarget=this.requestQueue.unqueue(),this.requestInterceptor&&this.requestInterceptor(this._requestDealTarget.config),this._pushToRequestPool(this._requestDealTarget))},e.prototype._runResp=function(t){t.request.aborted||(this.responseQueue.enqueue(t),this._emitResponseFlow());var e=t.request.fullURL;if(t.request.withRushStore&&t.request.xhr===this.store[e].xhr){var r=this.store[e];for(r.hasCache=!0,r.responseHeaders=t.headers;0<r.concurrentBuffer.length;){var s=r.concurrentBuffer.shift();!s.aborted&&this._runResp(new u(r.xhr,s,t.headers))}}},e.prototype._emitResponseFlow=function(){!this._responseDealTarget&&this.responseQueue.hasItem()&&(this._responseDealTarget=this.responseQueue.unqueue(),this.responseInterceptor&&this.responseInterceptor(this._responseDealTarget),this._handleComplete(this._responseDealTarget))},e.prototype._handleComplete=function(t){this._responseDealTarget=null,delete this.requestPool[t.request.getUUID()],this._emitResponseFlow(),o.test(t.status.toString())?t.completeWithFulfilled():t.completeWithFailed()},e.prototype._pushToRequestPool=function(t){this.requestPool[t.getUUID()]=t,this._requestDealTarget=null,t.send(),this._emitRequestFlow()},e.prototype.storeWithRule=function(t,e){var r=this,s=this.store[e.fullURL],o=function(){r._runResp(new u(s.xhr,e,s.responseHeaders))};if(!s||e.withRushStore)return this.rushRequest(t,e);s.concurrentBuffer.push(e),s.autoRetry&&(s.requestInstance.retryLimit+=1),s.hasCache&&(s.bufferTime&&-1!==s.bufferTime?(new Date).getTime()<=s.expires&&o():o())},e.prototype.rushRequest=function(t,e){e.sendAjax(),this.rushStore(e,e.fullURL,e.xhr,t.bufferTime,t.autoRetry)},e.prototype.checkStoreExpired=function(t){return!this.store[t]||(!this.store[t].bufferTime||(this.store[t].bufferTime?(new Date).getTime()>this.store[t].expires&&-1!==this.store[t].bufferTime:void 0))},e.prototype.rushStore=function(t,e,r,s,o){this.store[e]?this.store[e]=i({},this.store[e],{expires:(new Date).getTime()+s,xhr:r,autoRetry:o}):this.store[e]={hasCache:!1,concurrentBuffer:[],expires:(new Date).getTime()+s,responseHeaders:{},xhr:r,bufferTime:s,requestInstance:t,autoRetry:o}},e.prototype.setRequestInterceptor=function(t){this.requestInterceptor=t},e.prototype.setResponseInterceptor=function(t){this.responseInterceptor=t},e.prototype.request=function(t){var e=this;!function(t,e){if(t)throw new Error("[Error]: "+e+" !")}(!h(t,a),"request options type except to be ["+a+"] but got ["+typeof t+"]");var r,s,o=p(this.config,t),i=o.mode;if(i){var n=(r=i,!(!(s=[q,x])||!Array.isArray(s))&&-1!==s.indexOf(r));c(!n,"mode ["+i+'"] is invalid, it support to be "'+q+'" or "'+x+'"'),n||delete o.mode}var u=new g(o);return setTimeout(function(){e._runReq(u)}),u},e.prototype.get=function(t,e){return void 0===e&&(e={}),this.request(i({},e,{url:t,method:"get"}))},e.prototype.head=function(t,e){return void 0===e&&(e={}),this.request(i({},e,{url:t,method:"head"}))},e.prototype.options=function(t,e){return void 0===e&&(e={}),this.request(i({},e,{url:t,method:"options"}))},e.prototype.post=function(t,e,r){return void 0===e&&(e={}),void 0===r&&(r={}),this.request(i({},r,{url:t,data:e,method:"post"}))},e.prototype.put=function(t,e,r){return void 0===e&&(e={}),void 0===r&&(r={}),this.request(i({},r,{url:t,data:e,method:"put"}))},e.prototype.patch=function(t,e,r){return void 0===e&&(e={}),void 0===r&&(r={}),this.request(i({},r,{url:t,data:e,method:"patch"}))},e.prototype.delete=function(t,e,r){return void 0===e&&(e={}),void 0===r&&(r={}),this.request(i({},r,{url:t,data:e,method:"delete"}))},e.prototype.create=function(t){return new e(t)},e.prototype.all=function(t){return Promise.all(t)},e.prototype.race=function(t){return Promise.race(t)},e.prototype.createStrategy=function(t,e,r){return void 0===r&&(r=!0),new R(t,e,r)},e.prototype.setStrategy=function(t){this.storeStrategy=t},e.prototype.clearStore=function(e){e?Array.isArray(this.storeStrategy)?this.storeStrategy=this.storeStrategy.filter(function(t){return t.urlExp!==e}):this.storeStrategy.urlExp===e&&(this.storeStrategy=null):this.storeStrategy=null},e}());window.hx=t}();
